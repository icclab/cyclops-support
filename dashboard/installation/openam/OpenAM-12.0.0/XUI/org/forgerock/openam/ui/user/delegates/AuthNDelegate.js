define("org/forgerock/openam/ui/user/delegates/AuthNDelegate",["org/forgerock/commons/ui/common/util/Constants","org/forgerock/commons/ui/common/main/AbstractDelegate","org/forgerock/commons/ui/common/main/Configuration","org/forgerock/commons/ui/common/main/EventManager","org/forgerock/commons/ui/common/util/CookieHelper","org/forgerock/commons/ui/common/main/Router","org/forgerock/commons/ui/common/main/i18nManager","org/forgerock/openam/ui/user/delegates/SessionDelegate","org/forgerock/commons/ui/common/components/Messages"],function(e,t,n,r,i,s,o,u,a){var f=new t(e.host+"/"+e.context+"/json/authenticate"),l=[],c={};return f.begin=function(){var e,t={},r,s=$.Deferred();return n.globalData.auth.realm!=="/"&&(t.realm=n.globalData.auth.realm),c=_.clone(n.globalData.auth),n.globalData.auth.urlParams&&_.extend(t,n.globalData.auth.urlParams),r=i.getCookie(n.globalData.auth.cookieName),r&&(t.sessionUpgradeSSOTokenId=r),e="?"+$.param(t),f.serviceCall({type:"POST",headers:{"Accept-API-Version":"protocol=1.0,resource=2.0"},data:"",url:e,errorsHandlers:{unauthorized:{status:"401"}}}).done(function(e){s.resolve(e)}).fail(function(e){var t=$.parseJSON(e.responseText);t.hasOwnProperty("authId")?f.submitRequirements(t).done(function(e){f.resetProcess(),s.resolve(e)}).fail(function(){s.reject()}):s.reject()}),s},f.handleRequirements=function(e){e.hasOwnProperty("authId")?l.push(e):e.hasOwnProperty("tokenId")&&_.each(n.globalData.auth.cookieDomains,function(t){i.setCookie(n.globalData.auth.cookieName,e.tokenId,"","/",t,n.globalData.secureCookie)})},f.submitRequirements=function(t){var n=$.Deferred(),i=function(e){f.handleRequirements(e),n.resolve(e)},s=function(e){var t=l.length;f.resetProcess(),n.reject(t,e)},o=function(e){e.detail&&e.detail.failureUrl&&(console.log(e.detail.failureUrl),window.location.href=e.detail.failureUrl)};return f.serviceCall({type:"POST",headers:{"Accept-API-Version":"protocol=1.0,resource=2.0"},data:JSON.stringify(t),url:"",errorsHandlers:{unauthorized:{status:"401"},timeout:{status:"408"},"Internal Server Error ":{status:"500"}}}).then(i,function(t){var u,c,h,p=l.length,d=t.responseJSON.message,v=null;if(t.status===408)u=l[0],f.resetProcess(),f.begin().done(function(t){f.handleRequirements(t),t.hasOwnProperty("authId")?p===1?(u.authId=t.authId,f.submitRequirements(u).done(i).fail(s)):(r.sendEvent(e.EVENT_DISPLAY_MESSAGE_REQUEST,"loginTimeout"),n.resolve(t)):n.resolve(t)}).fail(s);else if(t.status===500)h={message:d,type:"error"},a.messages.addMessage(h);else{c=$.parseJSON(t.responseText);if(c.hasOwnProperty("authId"))f.submitRequirements(c).done(i).fail(s);else{switch(c.message){case"User Account Locked":v="loginFailureLockout";break;case"Maximum Sessions Limit Reached.":v="maxSessionsLimitOrSessionQuota";break;case" Your password has expired. Please contact service desk to reset your password":v="loginFailureLockout";break;default:v="authenticationFailed"}s(v),o(c)}}}),n},f.resetProcess=function(){l=[]},f.getRequirements=function(e){var t=$.Deferred();return l.length===0||!_.isEqual(n.globalData.auth,c)?f.begin(e).done(function(e){f.handleRequirements(e),t.resolve(e)}).fail(function(e){t.reject()}):t.resolve(l[l.length-1]),t},f.setGoToUrl=function(t,n){var r={};return r.goto=n,f.serviceCall({type:"POST",headers:{"Accept-API-Version":"protocol=1.0,resource=2.0"},data:JSON.stringify(r),url:"",serviceUrl:e.host+"/"+e.context+"/json/users?_action=validateGoto",errorsHandlers:{"Bad Request":{status:400}}})},f})